function doRequest(){d3.select(".initialInput").classed("hidden",!0);var e=query_text.node().value,t=[];t[0]=from_range.node().value.replace(/-/g,""),t[1]=to_range.node().value.replace(/-/g,""),request_url=request_string+e+"&begin_date="+t[0]+"&end_date="+t[1]+api_key+"&page="+page_num+"&callback=svc_search_v2_articlearch",makeCorsRequest("GET",request_url)}function createCORSRequest(e,t){var n=new XMLHttpRequest;return"withCredentials"in n?n.open(e,t,!0):"undefined"!=typeof XDomainRequest?(n=new XDomainRequest,n.open(e,t)):n=null,n}function makeCorsRequest(e,t){var n=createCORSRequest("GET",t);return n?(n.onload=function(){var e=n.responseText;handleResponse(e)},n.onerror=function(){alert("Woops, there was an error making the request.")},n.send(),void 0):(alert("CORS not supported"),void 0)}function handleResponse(e){var t,n=JSON.parse(e);50>page_num?(10==n.response.docs.length&&(page_num++,0==page_num%8?t=window.setTimeout(doRequest,1e3):doRequest()),n.response.docs.length>0&&(all_articles=all_articles.concat(n.response.docs)),n.response.docs.length<10&&(still_returning=!1)):still_returning=!1,0==still_returning&&organize_data(all_articles)}function resize_scale(e){time_scale.range([0,30*e])}function organize_data(e){for(var t=0;t<e.length;t++){var n=new Object;n=merge_options(n,e[t]),n.all_actors=[],n.themes=[],null==n.section_name&&(n.section_name="None");for(var a=0;a<e[t].keywords.length;a++)"subject"==e[t].keywords[a].name?n.themes.push(e[t].keywords[a].value):"type_of_material"!=e[t].keywords[a].name&&n.all_actors.push(e[t].keywords[a].value+"*&*"+e[t].keywords[a].name);data_by_actors.push(n)}for(var i=d3.nest().key(function(e){return e.actor}).key(function(e){return e.pub_date}).entries(data_by_actors),t=0;t<i.length;t++)i[t].values=i[t].values.sort(function(e,t){return new Date(e.key)-new Date(t.key)});i=i.sort(function(e,t){return new Date(e.values[0].key)-new Date(t.values[0].key)}),time_scale.domain(d3.extent(e,function(e){return new Date(time_format.parse(e.pub_date))})),context_time.domain(d3.extent(e,function(e){return new Date(time_format.parse(e.pub_date))})),context_time.domain([new Date(context_time.domain()[0].setDate(context_time.domain()[0].getDate()-1)),new Date(context_time.domain()[1].setDate(context_time.domain()[1].getDate()+1))]),makeLegend(e,section_y_scale),makeLegendForSections(e,context_section_legend),context_section_legend.range(d3.range(context_section_legend.domain().length));var r=findLevels(i),o=calcLinks(r);makeLegend(r,section_scale),0==visualizer_method&&whatToFollow(r,o)}function whatToFollow(e,t){var n=_.countBy(_.flatten(_.pluck(e,"all_actors")),_.identity),a=_.countBy(_.flatten(_.pluck(e,"themes")),_.identity);a=objToArray(a),a=a.filter(function(e){return e[1]>1}),a=a.sort(function(e,t){return t[1]-e[1]}),n=objToArray(n),n=n.filter(function(e){return e[1]>1}),n=n.sort(function(e,t){return t[1]-e[1]}),displaySelections(n,a,e,t)}function objToArray(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push([n,e[n]]);return t}function displaySelections(e,t,n,a){var i=d3.select(".themeList");i.selectAll("li").data(t).enter().append("li").html(function(e){return e[0].split("*&*")[0]+" ("+e[1]+")"}).on("click",function(e){the_selected_term=e[0],the_selected_type="themes",visualize(n,a),closeThemeModal()});var r=d3.select(".entityList");r.selectAll("li").data(e).enter().append("li").html(function(e){return e[0].split("*&*")[0]+" ("+e[1]+")"}).on("click",function(e){the_selected_term=e[0],the_selected_type="all_actors",visualize(n,a),closeThemeModal()}),d3.select(".allAccordian").on("click",function(){the_selected_term="all",the_selected_type="all",visualize(n,a),closeThemeModal()})}function closeThemeModal(){d3.select(".dimmer").classed("hidden",!0),d3.select(".selectEntity").classed("hidden",!0)}function makeLegend(e,t){t.domain(_.uniq(_.pluck(e,"section_name")))}function makeLegendForSections(e,t){var n=objToArray(_.countBy(_.pluck(e,"section_name")),_.identity).filter(function(e){return e[1]>3});n=n.sort(function(e,t){return t[1]-e[1]});for(var a=0;a<n.length;a++)n[a]=n[a][0];t.domain(n)}function calcLinks(e){for(var t=[],n=0;n<e.length;n++)getLink(e,n,"all_actors",t),getLink(e,n,"themes",t);return t}function getLink(e,t,n,a){for(var i=0;i<e[t][n].length;i++){var r=e.filter(function(a){return _.contains(a[n],e[t][n][i])&&a._id!==e[t]._id});if(r.length>0){r.sort(function(e,t){return new Date(e.pub_date)-new Date(t.pub_date)});var o=new Object;o.type=n,o.source=e[t],o.target=r[0],a.push(o)}}}function findLevels(e){for(var t=[],n=0;n<e.length;n++)for(var a=0;a<e[n].values.length;a++){var i=e[n].values[a].values[0];i.level=section_y_scale(e[n].values[a].values[0].section_name),i.name="a"+e[n].values[a].values[0]._id+e[n].values[a].values[0].section_name.split("*&*")[0].replace(/[|'" \.,-\/#!$%?\^&\*;:{}=\-_`~()? ]/g,""),i.x=time_scale(new Date(e[n].values[a].values[0].pub_date)),i.x2=function(){return this.x+article_width/2},i.width=article_width/2,i.height=article_height,i.saved_x=time_scale(new Date(e[n].values[a].values[0].pub_date)),i.y=section_y_scale(e[n].values[a].values[0].section_name),i.y2=function(){return this.y+this.height},i.height=article_height,i.relevance=300*Math.random()+100,i.radius=50,t.push(i)}return t}function merge_options(e,t){var n={};for(var a in e)n[a]=e[a];for(var a in t)n[a]=t[a];return n}function pluck(e,t){for(var n=[],a=0,i=e.length;i>a;a++)e[a].hasOwnProperty(t)&&n.push(e[a].key);return n}var time_format=d3.time.format("%Y-%m-%dT%H:%M:%SZ"),daily_format=d3.time.format("%Y-%m-%d"),margin={left:100,right:35,top:50,bottom:50},width=1100,height=500-margin.top-margin.bottom,font_scale=d3.scale.linear().range([1,8]),time_scale=d3.time.scale().range([0,width-margin.left-margin.right]),context_time=d3.time.scale().range([0,width-margin.left-margin.right]),xAxis=d3.svg.axis().scale(time_scale).orient("bottom"),xAxis2=d3.svg.axis().scale(context_time).orient("bottom"),request_string="http://api.nytimes.com/svc/search/v2/articlesearch.json?q=",api_key="&api-key=048cdc414bcc96df5946c6da1e0507ee:16:70037536",request_url,httpRequest,page_num=0,visualize_v1_button,visualize_v2_button,query_text,from_range,to_range,still_returning=!0,all_articles=[],data_by_actors=[],visualizer_method,section_scale=d3.scale.category20(),section_y_scale=d3.scale.ordinal().rangeBands([0,1e3]),context_section_legend=d3.scale.ordinal(),all_themes=[],the_selected_term="",the_selected_type="",article_width=35,article_height=45,image_url_starter="http://graphics8.nytimes.com/";window.onload=function(){visualize_v1_button=d3.select(".buttonV1"),visualize_v2_button=d3.select(".buttonV2"),query_text=d3.select(".inputText"),from_range=d3.select(".fromBox"),to_range=d3.select(".toBox"),visualize_v1_button.on("click",function(){d3.select(".selectEntity").classed("hidden",!1),visualizer_method=0,doRequest()}),visualize_v2_button.on("click",function(){d3.select(".selectEntity").classed("hidden",!1),visualizer_method=1,doRequest()})};